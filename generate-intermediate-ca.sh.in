#!/bin/bash -ex

function message()
{
	printf '\e[1m\e[38;5;27m%s\e[0m\n' "${1}"
}

function print_help()
{
	cat <<EOF
Usage: $0 <DIRECTORY> [-h|--help]
	   Generates intermediate ca files/scripts for this Root CA in
	   intermediates/DIRECTORY

EOF
}

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"
POSITIONAL=()
SIGNING_CA_DIR=%{SIGNING_CA_DIR}
INTERMEDIATE_SSL_CNF="${DIR}/templates/intermediate.cnf.in"

while [[ $# -gt 0 ]]; do
	key="$1"

	case $key in
		-h|--help)
			shift
			print_help
			exit 0
		;;
		*)
			POSITIONAL+=("$1")
			shift
		;;
	esac
done

set -- "${POSITIONAL[@]}"

OUTPUT=
if [ $# -ge 1 ]; then
	OUTPUT="intermediates/${1}"
	[ ! -d "${OUTPUT}" ] && mkdir -p "${OUTPUT}"
	[ "$(ls -A "${OUTPUT}")" ] && echo "Warning: Destination directory not empty"
else
	print_help
	exit 1
fi

pushd "${OUTPUT}" >/dev/null

mkdir certs crl csr newcerts private
chmod 700 private
touch index.txt
echo 1000 > serial
echo 1000 > crlnumber

sed "s#%{DIRECTORY}#${OUTPUT}#g" "${INTERMEDIATE_SSL_CNF}" > openssl.cnf

message "Generating CA private key"
openssl genrsa -aes256 -out private/intermediate.key.pem 4096
chmod 400 private/intermediate.key.pem

message "Generating Certificate signing request"
openssl req -config openssl.cnf -new -sha256 \
      -key private/intermediate.key.pem \
      -out csr/intermediate.csr.pem

message "Signing intermediate certificate"
openssl ca -config ${SIGNING_CA_DIR}/openssl.cnf -extensions v3_intermediate_ca \
      -days 3650 -notext -md sha256 \
      -in csr/intermediate.csr.pem \
      -out certs/intermediate.cert.pem

chmod 444 certs/intermediate.cert.pem

message ""
openssl x509 -noout -text \
	-certopt no_pubkey -certopt no_sigdump \
	-nameopt multiline \
	-in certs/intermediate.cert.pem

message "Verifying intermediate certificate"
openssl verify -CAfile ${SIGNING_CA_DIR}/certs/ca.cert.pem certs/intermediate.cert.pem

cat certs/intermediate.cert.pem ${SIGNING_CA_DIR}/certs/ca.cert.pem > certs/ca-chain.cert.pem
chmod 444 certs/ca-chain.cert.pem

popd >/dev/null
